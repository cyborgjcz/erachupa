;FileName_BATTLE.ERB --------------------------------
;eraMegaten으로부터 많이 참고했습니다.
;---------------------------------------------------
;BATTLE_START 
;---------------------------------------------------
@BATTLE_START

CALL LOAD_ENEMY
CALL INIT_BATTLE
CALL BATTLE_MAIN

RETURN 1
;---------------------------------------------------
;LOAD_ENEMY
;미리 TFLAG:1~6, TFLAG11~16에 세트된 데이터를 참고해
;배틀 동안 지속되는 적 캐릭터 등록
;---------------------------------------------------
@LOAD_ENEMY
#DIM DYNAMIC LCOUNT
#DIM DYNAMIC LCOUNT2
#DIM DYNAMIC ENEMY_KEY = 0
#DIM DYNAMIC ENEMY_LV = 1
#DIM DYNAMIC TO_ENTRY

TO_ENTRY = CHARANUM;적을 임시로 등록할 캐릭등록번호=현재 캐릭수

FOR LCOUNT,1,7
    SIF !TFLAG:LCOUNT;미리 설정한 TFLAG:1~6(적위치)에 아무것도 없다면 패스
        CONTINUE
    ENEMY_KEY = TFLAG:LCOUNT;CSV 번호 취득
    ADDCHARA ENEMY_KEY
    IF TFLAG:(10+LCOUNT)
        ENEMY_LV = TFLAG:(10+LCOUNT)
        BASE:TO_ENTRY:레벨 = ENEMY_LV
    ELSE
        BASE:TO_ENTRY:레벨 = CFLAG:ENEMY_KEY:초기레벨
    ENDIF
    CALL ENEMY_LEVEL(TO_ENTRY)
    ;적 보유 스킬 설정.
    FOR LCOUNT2,22,30
        AVAILABLE_SKILL:TO_ENTRY:(-22+LCOUNT2) = CFLAG:TO_ENTRY:LCOUNT2
    NEXT
    TFLAG:LCOUNT = TO_ENTRY;해당 적위치에 추가한 적의 캐릭등록번호 대입
    TO_ENTRY += 1
    TFLAG:적캐릭터초기화 += 1
NEXT

RETURN 1
;---------------------------------------------------
;GET_ENEMY
;특정적위치의 적등록번호를 반환하는 식중함수
;---------------------------------------------------
@GET_ENEMY(WHERE)
#FUNCTION
#DIM DYNAMIC WHERE

RETURNF TFLAG:WHERE
;---------------------------------------------------
;INIT_BATTLE
;---------------------------------------------------
@INIT_BATTLE
#DIM DYNAMIC LCOUNT
;전투 경과 시간 초기화
TFLAG:경과시간 = 0
;전투결과 초기화
TFLAG:전투결과 = 0
;장비에 의한 스탯 증감 초기화
FOR LCOUNT,1,3
    IF CFLAG:(FLAG:LCOUNT):변신 != 0
        CALL GO_TRANSFORM(FLAG:LCOUNT)
    ELSE
        CALL EQ_APPLY_STAT(FLAG:LCOUNT)
    ENDIF
NEXT

FOR LCOUNT,0,2
    CFLAG:(FLAG:LCOUNT):ATB카운터 = 0
NEXT
RETURN 1
;---------------------------------------------------
;BATTLE_MAIN
;배틀 루프
;---------------------------------------------------
@BATTLE_MAIN
#DIM DYNAMIC BATTLE_LOOP = 1
#DIM DYNAMIC LCOUNT = 0
#DIM DYNAMIC LCOUNT2 = 0

#DIM DYNAMIC LENEMY_NUM;적등록번호
#DIM DYNAMIC TCALLER;전투회화발화자

#DIM DYNAMIC REMAINTIME
#DIM DYNAMIC TIMECOUNT
#DIM DYNAMIC POISONTIMER

#DIM DYNAMIC UILEN = 12
#DIMS DYNAMIC COMMESSAGE,2

#DIMS DYNAMIC COMMANDS;커맨드 실행 내용
#DIM DYNAMIC COM_TARGETV;커맨드 실행 대상
#DIM DYNAMIC COM_USER;커맨드 실행 주체
#DIM DYNAMIC COM_SKILLNUM;커맨드 실행 스킬 번호

#DIMS DYNAMIC TALK_WHAT
#DIM DYNAMIC TALK_WHATV

IF TFLAG:0 < 1 ;첫턴처리
    {
        PRINTFORML ＿人人人人人人人人人人人人人人人人人＿
        \n＞　ＥＮＥＭＹ　ＥＮＣＯＵＮＴＥＲ　＜
        \n￣Y^Y^Y^Y^Y^Y^Y^Y^Y^Y^Y^Y^Y^Y^Y￣
    }
    TCALLER = RAND:2+1
    CALL BATTLE_TALK("ENCOUNTER", TCALLER)
    CALL BATTLE_TALK("ENCOUNTER", TCALLER^3, 1)
ENDIF


REMAINTIME = ATB_TIME
POISONTIMER = POISONTIME
CALL RESET_BATTLE_CURSOR

DO
    ;전열이 비었다면, 후열을 전열로 땡긴다
    LCOUNT2 = 1
    FOR LCOUNT,1,4
        LENEMY_NUM = GET_ENEMY(LCOUNT)
        SIF !LENEMY_NUM
            CONTINUE
        LCOUNT2 += 1
    NEXT
    IF LCOUNT2 < 2
        FOR LCOUNT,4,7
            TFLAG:(LCOUNT-3) = GET_ENEMY(LCOUNT)
            TFLAG:LCOUNT = 0
        NEXT
    ENDIF
    ;아군 전멸 판정
    LCOUNT2 = 0
    FOR LCOUNT,1,3
        SIF ISDYING(FLAG:LCOUNT)
            LCOUNT2 += 1
    NEXT
    IF LCOUNT2 >= 2
        TFLAG:전투결과 = 2
        BATTLE_LOOP = 0
        GOTO BATTLE_END
    ENDIF
    ;적 전멸 판정
    LCOUNT2 = 0
    FOR LCOUNT,1,7
        SIF TFLAG:LCOUNT == 0 || ISDYING(TFLAG:LCOUNT)
            LCOUNT2 += 1
    NEXT
    IF LCOUNT2 >= 6
        TFLAG:전투결과 = 1
        BATTLE_LOOP = 0
        GOTO BATTLE_END
    ENDIF
    ;공격 스킬 커서 초기화
    FOR LCOUNT2,9,11
        IF !TFLAG:(TFLAG:LCOUNT2) || ISDYING(TFLAG:(TFLAG:LCOUNT2))
            FOR LCOUNT,1,7
                IF TFLAG:LCOUNT && !ISDYING(TFLAG:LCOUNT)
                    TFLAG:LCOUNT2 = LCOUNT
                    BREAK
                ENDIF
            NEXT
        ENDIF
    NEXT
    ;적 묘사 및 스킬 목록
    DRAWLINE
    FOR LCOUNT2,4,-2,-3 ;후열부터 시작해서 전열로 반복(4,1)
        FOR LCOUNT,LCOUNT2,LCOUNT2+3 ;적 이름 표시(4,5,6)(1,2,3)
            {
                IF (TFLAG:동료1ATB커서상태 != 3 && LCOUNT != 6 && LCOUNT != 3) ||
                (TFLAG:동료2ATB커서상태 != 3 && (LCOUNT == 6 || LCOUNT == 3))
            }
                LENEMY_NUM = GET_ENEMY(LCOUNT)
                SIF !LENEMY_NUM
                    SETCOLORBYNAME DimGray
                CALL SETCOLOR_BATTLE_ENEMY(LCOUNT)
                SIF ISDYING(LENEMY_NUM) != 0
                    SETCOLORBYNAME DimGray
                PRINTFORM ［%TOFULL(TOSTR(LCOUNT))%］
                IF LENEMY_NUM > 0
                    PRINTFORM %CALLNAME:LENEMY_NUM%
                    PRINT_SPACE 100 * (6 - STRLENSU(CALLNAME:LENEMY_NUM))
                ELSE
                    PRINT ＥＭＰＴＹ
                    PRINT_SPACE 100
                ENDIF 
                RESETCOLOR
            ELSE
                SELECTCASE LCOUNT
                    CASE 1
                        CALL SHOW_BATTLE_SKILL_SELECT_NAME(1,4)
                    CASE 2
                        CALL SHOW_BATTLE_SKILL_SELECT_NAME(1,5)
                    CASE 3
                        CALL SHOW_BATTLE_SKILL_SELECT_NAME(2,4)
                    CASE 4
                        CALL SHOW_BATTLE_SKILL_SELECT_NAME(1,0)
                    CASE 5
                        CALL SHOW_BATTLE_SKILL_SELECT_NAME(1,1)
                    CASE 6
                        CALL SHOW_BATTLE_SKILL_SELECT_NAME(2,0)
                ENDSELECT
            ENDIF
            IF (LCOUNT == 6 || LCOUNT == 3) && TFLAG:동료2ATB커서상태 == 3
                ;여기에 확장 스킬화면 작성
                SELECTCASE LCOUNT
                    CASE 6
                        CALL SHOW_BATTLE_SKILL_SELECT_NAME(2,1)
                    CASE 3
                        CALL SHOW_BATTLE_SKILL_SELECT_NAME(2,5)
                ENDSELECT
            ENDIF
        NEXT
        PRINTL
        FOR LCOUNT,LCOUNT2,LCOUNT+3 ;적HP표시
            {
                IF (TFLAG:동료1ATB커서상태 != 3 && LCOUNT != 6 && LCOUNT != 3) ||
                (TFLAG:동료2ATB커서상태 != 3 && (LCOUNT == 6 || LCOUNT == 3))
            }
                LENEMY_NUM = GET_ENEMY(LCOUNT)
                IF !LENEMY_NUM
                    SETCOLORBYNAME DimGray
                    PRINTFORM %"　"*3%[%"-"*(UILEN-2)%]
                    RESETCOLOR
                    CONTINUE
                ENDIF
                PRINTFORM %"ＨＰ："%
                CALL PRINT_COLORBAR(BASE:LENEMY_NUM:희망,MAXBASE:LENEMY_NUM:희망,96,UNICODE(0x258F), UNICODE(0x258F), 0xB73232, 0x626262)
            ELSE
                SELECTCASE LCOUNT
                    CASE 1
                        CALL SHOW_BATTLE_SKILL_SELECT_NAME(1,6)
                    CASE 2
                        CALL SHOW_BATTLE_SKILL_SELECT_NAME(1,7)
                    CASE 3
                        CALL SHOW_BATTLE_SKILL_SELECT_NAME(2,6)
                    CASE 4
                        CALL SHOW_BATTLE_SKILL_SELECT_NAME(1,2)
                    CASE 5
                        CALL SHOW_BATTLE_SKILL_SELECT_NAME(1,3)
                    CASE 6
                        CALL SHOW_BATTLE_SKILL_SELECT_NAME(2,2)
                ENDSELECT
            ENDIF            
            IF (LCOUNT == 6 || LCOUNT == 3) && TFLAG:동료2ATB커서상태 == 3
                ;여기에 확장 스킬화면 작성
                SELECTCASE LCOUNT
                    CASE 6
                        CALL SHOW_BATTLE_SKILL_SELECT_NAME(2,3)
                    CASE 3
                        CALL SHOW_BATTLE_SKILL_SELECT_NAME(2,7)
                ENDSELECT
            ENDIF
        NEXT
        PRINTL
    NEXT
    DRAWLINE
    ;커맨드 상태 표시
    FOR LCOUNT,0,2
        CALL SET_COMMESSAGE(COMMESSAGE:LCOUNT,LCOUNT)
        STRLENSU COMMESSAGE:LCOUNT
        PRINTFORM %COMMESSAGE:LCOUNT%
        PRINT_SPACE 100*(14-RESULT)
    NEXT
    PRINTL
    CALL SHOW_BATTLE_COMMAND
    ;캐릭터 이름 및 ATB 바 표시
    FOR LCOUNT,1,3
        STRLENSU CALLNAME:(FLAG:LCOUNT);FLAG:1~2 는 동료1 동료2
        PRINTFORM %CALLNAME:(FLAG:LCOUNT)%
        PRINT_SPACE 100*(6 - RESULT)
        SIF CFLAG:(FLAG:LCOUNT):ATB카운터 >= MAX_ATB
            ATB_COLOR = 0x3097d3
        CALL PRINT_COLORBAR(CFLAG:(FLAG:LCOUNT):ATB카운터, MAX_ATB, 128, UNICODE(0x258F), UNICODE(0x258F), ATB_COLOR, 0x626262)
        ATB_COLOR = 0x0067a3
    NEXT
    PRINTL
    ;HP, SP 표시
    FOR LCOUNT,1,3
        PRINTFORM ＨＰ%TOSTR(BASE:(FLAG:LCOUNT):희망),4,RIGHT%／%TOSTR(MAXBASE:(FLAG:LCOUNT):희망),4,RIGHT%  
        PRINTFORM ＳＰ%TOSTR(BASE:(FLAG:LCOUNT):영혼),4,RIGHT%／%TOSTR(MAXBASE:(FLAG:LCOUNT):영혼),4,RIGHT%  
    NEXT
    PRINTL
    ;입력
    GETMILLISECOND
    TIMECOUNT = RESULT
    TONEINPUTS REMAINTIME,"탌",0,""
    ;입력처리
    CALL BATTLE_INPUT(RESULTS,COMMANDS,COM_TARGETV,COM_USER)
    GETMILLISECOND
    REMAINTIME -= (RESULT - TIMECOUNT)
    POISONTIMER -= (RESULT - TIMECOUNT)
    ;ATB처리
    IF REMAINTIME < 0
        IF !ISDYING(FLAG:동료1)
            SIF CFLAG:(FLAG:동료1):ATB카운터 < MAX_ATB
                CFLAG:(FLAG:동료1):ATB카운터 += BASE:(FLAG:동료1):행동력
            SIF CFLAG:(FLAG:동료1):ATB카운터 >= MAX_ATB
                CFLAG:(FLAG:동료1):ATB카운터 = MAX_ATB
        ENDIF
        IF !ISDYING(FLAG:동료2)
            SIF CFLAG:(FLAG:동료2):ATB카운터 < MAX_ATB
                CFLAG:(FLAG:동료2):ATB카운터 += BASE:(FLAG:동료2):행동력
            SIF CFLAG:(FLAG:동료2):ATB카운터 >= MAX_ATB
                CFLAG:(FLAG:동료2):ATB카운터 = MAX_ATB
        ENDIF
        ;적ATB 처리
        FOR LCOUNT,1,7
            SIF !TFLAG:LCOUNT
                CONTINUE
            SIF ISDYING(TFLAG:LCOUNT)
                CONTINUE
            SIF CFLAG:(TFLAG:LCOUNT):ATB카운터 < MAX_ATB
                CFLAG:(TFLAG:LCOUNT):ATB카운터 += BASE:(TFLAG:LCOUNT):행동력
            IF CFLAG:(TFLAG:LCOUNT):ATB카운터 >= MAX_ATB
                CFLAG:(TFLAG:LCOUNT):ATB카운터 = MAX_ATB
                ENEMY_MOVE = LCOUNT;적행동트리거
                BREAK;한번에 한명의 적만 행동한다
            ENDIF
        NEXT
        REMAINTIME = ATB_TIME
        TFLAG:경과시간 += (RESULT - TIMECOUNT)
    ENDIF
    IF POISONTIMER <= 0
        ;독 대미지 처리
        FOR LCOUNT,1,3
            IF (CFLAG:(FLAG:LCOUNT):상태이상 & 2) != 0
                BASE:(FLAG:LCOUNT):희망 -= (MAXBASE:(FLAG:LCOUNT):희망 / 32)
                IF 상태이상시간:(FLAG:LCOUNT):1 > 0
                    상태이상시간:(FLAG:LCOUNT):1 -= 1
                ELSE
                    CFLAG:(FLAG:LCOUNT):상태이상 -= 2
                ENDIF
            ENDIF
        NEXT
        FOR LCOUNT,1,7
            IF (CFLAG:(TFLAG:LCOUNT):상태이상 & 2) != 0
                BASE:(TFLAG:LCOUNT):희망 -= (MAXBASE:(TFLAG:LCOUNT):희망 / 32)
                IF 상태이상시간:(TFLAG:LCOUNT):1 > 0
                    상태이상시간:(TFLAG:LCOUNT):1 -= 1
                ELSE
                    CFLAG:(TFLAG:LCOUNT):상태이상 -= 2
                ENDIF
            ENDIF
        NEXT
        POISONTIMER = POISONTIME
    ENDIF
    ;적 행동
    IF ENEMY_MOVE
        CLEARLINE 1
        REUSELASTLINE
        ;간이 AI 함수를 호출한다. CFLAG를 참조하여 얻은 함수명이 존재하지 않으면 AI0 호출
        TRYCCALLFORM BATTLE_AI{CFLAG:(TFLAG:ENEMY_MOVE):AI타입}_COMMAND,ENEMY_MOVE
        CATCH
            DEBUGPRINTFORML BATTLE_AI{CFLAG:(TFLAG:ENEMY_MOVE):AI타입}_COMMAND 호출 실패
            CALL BATTLE_AI0_COMMAND(ENEMY_MOVE)
        ENDCATCH
        SELECTCASE RESULT:0
            CASE 0
                COMMANDS = "ATTACK"
            CASE 1
                COMMANDS = "SKILL"
            CASE 2
                COMMANDS = "GUARD"
            CASE 3
                COMMANDS = "TRANS"
        ENDSELECT
        COM_TARGETV = RESULT:1
        COM_USER = ENEMY_MOVE
        COM_SKILLNUM = RESULT:2
        CFLAG:(TFLAG:ENEMY_MOVE):방어 = 0
        CALL RUN_BATTLE_COMMAND(COMMANDS,COM_TARGETV,COM_USER,COM_SKILLNUM,1)
        ENEMY_MOVE = 0
    ELSE
        ;적 행동이 아닐 때 아군 행동 실행
        IF COMMANDS != ""
            CFLAG:(FLAG:COM_USER):방어 = 0
            CALL RUN_BATTLE_COMMAND(COMMANDS,COM_TARGETV,COM_USER,COM_SKILLNUM)
        ELSE
            IF RESULTS == ""
                CLEARLINE 6+1+2+2
            ELSE 
                CLEARLINE 6+1+2+2+1
            ENDIF
            REUSELASTLINE
            ;전투회화 TFLAG 복구
            SIF !ISDYING(FLAG:동료1) && (TFLAG:불리전투회화스위치 & POWER(2,11))
                TFLAG:불리전투회화스위치 -= POWER(2,11)
            SIF !ISDYING(FLAG:동료2) && (TFLAG:불리전투회화스위치 & POWER(2,12))
                TFLAG:불리전투회화스위치 -= POWER(2,12)
            SIF !ISBASUTE(FLAG:동료1,2) && (TFLAG:불리전투회화스위치 & POWER(2,3))
                TFLAG:불리전투회화스위치 -= POWER(2,3);동료1독
            SIF !ISBASUTE(FLAG:동료2,2) && (TFLAG:불리전투회화스위치 & POWER(2,4))
                TFLAG:불리전투회화스위치 -= POWER(2,4);동료2독
            SIF !ISBASUTE(FLAG:동료1,3) && (TFLAG:불리전투회화스위치 & POWER(2,5))
                TFLAG:불리전투회화스위치 -= POWER(2,5);동료1출혈
            SIF !ISBASUTE(FLAG:동료2,3) && (TFLAG:불리전투회화스위치 & POWER(2,6))
                TFLAG:불리전투회화스위치 -= POWER(2,6);동료2출혈
            SIF !ISBASUTE(FLAG:동료1,4) && (TFLAG:불리전투회화스위치 & POWER(2,7))
                TFLAG:불리전투회화스위치 -= POWER(2,7);동료1공포
            SIF !ISBASUTE(FLAG:동료2,4) && (TFLAG:불리전투회화스위치 & POWER(2,8))
                TFLAG:불리전투회화스위치 -= POWER(2,8);동료2공포
            SIF !ISBASUTE(FLAG:동료1,5) && (TFLAG:불리전투회화스위치 & POWER(2,9))
                TFLAG:불리전투회화스위치 -= POWER(2,9);동료1격앙
            SIF !ISBASUTE(FLAG:동료2,5) && (TFLAG:불리전투회화스위치 & POWER(2,10))
                TFLAG:불리전투회화스위치 -= POWER(2,10);동료2격앙
            SIF (((MAXBASE:(FLAG:동료1):희망 * 4) / 5) < BASE:(FLAG:동료1):희망) && ((TFLAG:불리전투회화스위치 & 1) != 0)
                TFLAG:불리전투회화스위치 -= 1
            SIF (((MAXBASE:(FLAG:동료2):희망 * 4) / 5) < BASE:(FLAG:동료2):희망) && ((TFLAG:불리전투회화스위치 & 2) != 0)
                TFLAG:불리전투회화스위치 -= 2
            ;자동 전투회화
            TALK_WHAT =
            TALK_WHATV = 0
            IF CFLAG:(FLAG:동료1):상태이상 || CFLAG:(FLAG:동료2):상태이상
                ;상태이상 전투회화
                IF ISDYING(FLAG:동료1) && !(TFLAG:불리전투회화스위치 & POWER(2,11))
                    ; 동료1 전투불능
                    TALK_WHAT '= "DYING"
                    TALK_WHATV = 1
                    TCALLER = 2
                    TFLAG:불리전투회화스위치 += POWER(2,11)
                ELSEIF ISDYING(FLAG:동료2) && !(TFLAG:불리전투회화스위치 & POWER(2,12))
                    ; 동료2 전투불능
                    TALK_WHAT '= "DYING"
                    TALK_WHATV = 2
                    TCALLER = 1
                    TFLAG:불리전투회화스위치 += POWER(2,12)
                ELSEIF ISBASUTE(FLAG:동료1,2) && !(TFLAG:불리전투회화스위치 & POWER(2,3))
                    ; 동료1 독
                    TALK_WHAT '= "POISON"
                    TALK_WHATV = 1
                    TCALLER = (RAND:2)+1
                    TFLAG:불리전투회화스위치 += POWER(2,3)
                ELSEIF ISBASUTE(FLAG:동료2,2) && !(TFLAG:불리전투회화스위치 & POWER(2,4))
                    ; 동료2 독
                    TALK_WHAT '= "POISON"
                    TALK_WHATV = 2
                    TCALLER = (RAND:2)+1
                    TFLAG:불리전투회화스위치 += POWER(2,4)
                ELSEIF ISBASUTE(FLAG:동료1,3) && !(TFLAG:불리전투회화스위치 & POWER(2,5))
                    ; 동료1 출혈
                    TALK_WHAT '= "BLEEDING"
                    TALK_WHATV = 1
                    TCALLER = (RAND:2)+1
                    TFLAG:불리전투회화스위치 += POWER(2,5)
                ELSEIF ISBASUTE(FLAG:동료2,3) && !(TFLAG:불리전투회화스위치 & POWER(2,6))
                    ; 동료2 출혈
                    TALK_WHAT '= "BLEEDING"
                    TALK_WHATV = 2
                    TCALLER = (RAND:2)+1
                    TFLAG:불리전투회화스위치 += POWER(2,6)
                ELSEIF ISBASUTE(FLAG:동료1,4) && !(TFLAG:불리전투회화스위치 & POWER(2,7))
                    ; 동료1 공포
                    TALK_WHAT '= "TERRIFIED"
                    TALK_WHATV = 1
                    TCALLER = (RAND:2)+1
                    TFLAG:불리전투회화스위치 += POWER(2,7)
                ELSEIF ISBASUTE(FLAG:동료2,4) && !(TFLAG:불리전투회화스위치 & POWER(2,8))
                    ; 동료2 공포
                    TALK_WHAT '= "TERRIFIED"
                    TALK_WHATV = 2
                    TCALLER = (RAND:2)+1
                    TFLAG:불리전투회화스위치 += POWER(2,8)
                ELSEIF ISBASUTE(FLAG:동료1,5) && !(TFLAG:불리전투회화스위치 & POWER(2,9))
                    ; 동료1 격앙
                    TALK_WHAT '= "ENRAGE"
                    TALK_WHATV = 1
                    TCALLER = (RAND:2)+1
                    TFLAG:불리전투회화스위치 += POWER(2,9)
                ELSEIF ISBASUTE(FLAG:동료2,5) && !(TFLAG:불리전투회화스위치 & POWER(2,10))
                    ; 동료2 격앙
                    TALK_WHAT '= "ENRAGE"
                    TALK_WHATV = 2
                    TCALLER = (RAND:2)+1
                    TFLAG:불리전투회화스위치 += POWER(2,10)
                ENDIF
            ELSEIF ((BASE:(FLAG:동료1):희망 * 5) < MAXBASE:(FLAG:동료1):희망) && ((TFLAG:불리전투회화스위치 & 1) == 0)
                ;동료1 체력 낮음 전투회화
                TALK_WHAT '= "CRITHP"
                TALK_WHATV = 1
                TCALLER = (RAND:2)+1
                TFLAG:불리전투회화스위치 += 1
            ELSEIF ((BASE:(FLAG:동료2):희망 * 5) < MAXBASE:(FLAG:동료2):희망) && ((TFLAG:불리전투회화스위치 & 2) == 0)
                ;동료2 체력 낮음 전투회화
                TALK_WHAT '= "CRITHP"
                TALK_WHATV = 2
                TCALLER = (RAND:2)+1
                TFLAG:불리전투회화스위치 += 2
            ELSE
                IF TFLAG:경과시간 >= 120000 && TFLAG:전투경과시간회화 == 0
                    TALK_WHAT '= "TIMEFLIES"
                    TALK_WHATV = 1
                    TCALLER = (RAND:2)+1
                    TFLAG:전투경과시간회화 += 1
                ELSEIF TFLAG:경과시간 >= 240000 && TFLAG:전투경과시간회화 == 1
                    TALK_WHAT '= "TIMEFLIES"
                    TALK_WHATV = 2
                    TCALLER = (RAND:2)+1
                    TFLAG:전투경과시간회화 += 1
                ELSEIF TFLAG:경과시간 >= 360000 && TFLAG:전투경과시간회화 == 2
                    TALK_WHAT '= "TIMEFLIES"
                    TALK_WHATV = 3
                    TCALLER = (RAND:2)+1
                    TFLAG:전투경과시간회화 += 1
                ENDIF
            ENDIF
            IF TALK_WHAT != ""
                CALL BATTLE_TALK(TALK_WHAT,TCALLER,,TALK_WHATV)
                CALL BATTLE_TALK(TALK_WHAT,TCALLER^3,1,TALK_WHATV)
            ENDIF
        ENDIF
    ENDIF
    $BATTLE_END
LOOP BATTLE_LOOP

IF TFLAG:전투결과 == 1
    ;승리
    PRINTFORML TFLAG:전투결과 == {TFLAG:전투결과} (승리)
    FOR LCOUNT,1,3
        FOR LCOUNT2,1,7
            IF TFLAG:LCOUNT2
                RPG_EXP:(FLAG:LCOUNT):0 += CFLAG:(TFLAG:LCOUNT2):제공경험치
                TOTAL_RPG_EXP:(FLAG:LCOUNT):0 += CFLAG:(TFLAG:LCOUNT2):제공경험치
            ENDIF
        NEXT
    NEXT
    FOR LCOUNT,1,3
        CALL LEVELUP(FLAG:LCOUNT)
        IF RESULT != 0
            PRINTFORML %조사처리(CALLNAME:(FLAG:LCOUNT),"은")% 레벨이 {RESULT} 올라 레벨 {BASE:(FLAG:LCOUNT):레벨}이 되었다!
            WAITANYKEY
            CALL RPG_STATUP(FLAG:LCOUNT,RESULT)
            ;능력치 상승
        ENDIF
    NEXT
ELSEIF TFLAG:전투결과 == 2
    ;패배
    PRINTFORML TFLAG:전투결과 == {TFLAG:전투결과} (패배)
ENDIF

;임시 등록한 적 캐릭터 삭제
FOR LCOUNT,0,TFLAG:적캐릭터초기화
    DELCHARA CHARANUM-1
NEXT
TFLAG:적캐릭터초기화 = 0
@RUN_BATTLE_COMMAND(COMMANDS,TARGETV,USERV,SKILLV,ISENEMY=0)
#DIM DYNAMIC LCOUNT
#DIM DYNAMIC LNUM
#DIMS DYNAMIC COMMANDS
#DIM DYNAMIC TARGETV
#DIM DYNAMIC USERV
#DIM DYNAMIC SKILLV
#DIM DYNAMIC ISENEMY
SELECTCASE COMMANDS
    CASE "ATTACK"
        SKILLV = 0
    CASE "SKILL"
        SIF !ISENEMY
            SKILLV = AVAILABLE_SKILL:(FLAG:USERV):(TFLAG:(16+USERV))
    CASE "GUARD"
        SKILLV = 1
    CASE "TRANS"
        SKILLV = 1
ENDSELECT

;격앙 처리
{
    IF ((!ISENEMY && (CFLAG:(FLAG:USERV):상태이상 & 16) != 0) ||
    (ISENEMY && (CFLAG:(TFLAG:USERV):상태이상 & 16) != 0)) && (RAND:3 == 0)
}
    TARGETV = 0
    IF !ISENEMY
        PRINTFORML %조사처리(CALLNAME:(FLAG:USERV),"은")% 엉뚱한 공격을 했다!
        IF 상태이상시간:(FLAG:USERV):4 > 0
            상태이상시간:(FLAG:USERV):4 -= 1
        ELSE
            CFLAG:(FLAG:USERV):상태이상 -= 16
        ENDIF
        DO
            LNUM = (RAND:6)+1
            SIF TFLAG:LNUM != 0
                TARGETV = LNUM
        LOOP TARGETV == 0
    ELSEIF ISENEMY
        PRINTFORML %조사처리(CALLNAME:(TFLAG:USERV),"은")% 엉뚱한 공격을 했다!
        IF 상태이상시간:(TFLAG:USERV):4 > 0
            상태이상시간:(TFLAG:USERV):4 -= 1
        ELSE
            CFLAG:(TFLAG:USERV):상태이상 -= 16
        ENDIF
        TARGETV = (RAND:2)+1
    ENDIF
    SKILLV = 0
ENDIF

;전투불능의 적을 공격할 수는 없다
SIF !ISENEMY && SKILL_DATA:SKILLV:0 == 0 && ISDYING(TFLAG:TARGETV)
    RETURN 0
SIF ISENEMY && SKILL_DATA:SKILLV:0 == 0 && ISDYING(FLAG:TARGETV)
    RETURN 0

;미리 처리하겠지만, 오작동을 막기 위해.
;아군 스탯이 스킬 조건스탯에 미달하는 경우 발동 불가
IF !ISENEMY && COMMANDS == "SKILL" && (SKILL_DATA:SKILLV:2 > BASE:(FLAG:USERV):((SKILL_DATA:SKILLV:1)+1) && SKILL_DATA:SKILLV:3 == 0)
    RETURN 0
ENDIF

IF SKILL_DATA:SKILLV:10 > 0
    IF !ISENEMY
        IF BASE:(FLAG:USERV):(SKILL_DATA:SKILLV:11) >= SKILL_DATA:SKILLV:10
            BASE:(FLAG:USERV):(SKILL_DATA:SKILLV:11) -= SKILL_DATA:SKILLV:10
        ELSE
            RETURN 0
        ENDIF
    ELSEIF ISENEMY
        IF BASE:(TFLAG:USERV):(SKILL_DATA:SKILLV:11) >= SKILL_DATA:SKILLV:10
            BASE:(TFLAG:USERV):(SKILL_DATA:SKILLV:11) -= SKILL_DATA:SKILLV:10
        ELSE
            RETURN 0
        ENDIF
    ENDIF
ENDIF

;출혈 처리
IF !ISENEMY && (CFLAG:(FLAG:USERV):상태이상 & 4) != 0
    BASE:(FLAG:USERV):희망 -= (MAXBASE:(FLAG:USERV):희망 / 32)
    PRINTFORML %조사처리(CALLNAME:(FLAG:USERV),"은")% {MAXBASE:(FLAG:USERV):희망 / 32} 피해를 입었다!
    WAITANYKEY
    IF 상태이상시간:(FLAG:USERV):2 > 0
        상태이상시간:(FLAG:USERV):2 -= 1
    ELSE
        CFLAG:(FLAG:USERV):상태이상 -= 4
    ENDIF
ENDIF
IF ISENEMY && (CFLAG:(TFLAG:USERV):상태이상 & 4) != 0
    BASE:(TFLAG:USERV):희망 -= (MAXBASE:(TFLAG:USERV):희망 / 32)
    PRINTFORML ({USERV}) %조사처리(CALLNAME:(TFLAG:USERV),"은")% {MAXBASE:(TFLAG:USERV):희망 / 32} 피해를 입었다!
    WAITANYKEY
    IF 상태이상시간:(TFLAG:USERV):2 > 0
        상태이상시간:(TFLAG:USERV):2 -= 1
    ELSE
        CFLAG:(TFLAG:USERV):상태이상 -= 4
    ENDIF
ENDIF

;공포 처리
{
    IF ((!ISENEMY && (CFLAG:(FLAG:USERV):상태이상 & 8) != 0) ||
    (ISENEMY && (CFLAG:(TFLAG:USERV):상태이상 & 8) != 0)) && (RAND:3 == 0)
}
    IF ISENEMY
        PRINTFORML ({USERV}) %조사처리(CALLNAME:(TFLAG:USERV),"은")% 움직일 수 없다!
        IF 상태이상시간:(TFLAG:USERV):3 > 0
            상태이상시간:(TFLAG:USERV):3 -= 1
        ELSE
            CFLAG:(TFLAG:USERV):상태이상 -= 8
        ENDIF
    ELSEIF !ISENEMY
        PRINTFORML %조사처리(CALLNAME:(FLAG:USERV),"은")% 움직일 수 없다!
        IF 상태이상시간:(FLAG:USERV):3 > 0
            상태이상시간:(FLAG:USERV):3 -= 1
        ELSE
            CFLAG:(FLAG:USERV):상태이상 -= 8
        ENDIF
    ENDIF
    WAITANYKEY
    GOTO SKIP_ACTION
ENDIF

;여기서 실제 스킬 내용 실행
;스킬 유형은 공격, 범위 유형은 단일일때
IF COMMANDS == "TRANS"
    CALL GO_TRANSFORM(USERV,ISENEMY)
ELSEIF SKILL_DATA:SKILLV:0 == 0 && SKILL_DATA:SKILLV:5 == 0
    CALL SKILL_SINGLE_ATTACK(TARGETV,USERV,SKILLV,ISENEMY)
;자가 힐/버프일때
ELSEIF SKILL_DATA:SKILLV:0 == 0 && SKILL_DATA:SKILLV:5 == 3
    CALL SKILL_ALL_ATTACK(USERV,SKILLV,ISENEMY)
ELSEIF SKILL_DATA:SKILLV:0 == 1 && SKILL_DATA:SKILLV:5 == 1
    CALL SKILL_HEAL_SELF(USERV,SKILLV,ISENEMY)
;방어 스킬(카운터 등 포함 예정)
ELSEIF SKILL_DATA:SKILLV:0 == 2
    CALL SKILL_GUARD(USERV,SKILLV,ISENEMY)
ENDIF
$SKIP_ACTION
IF !ISENEMY
    CFLAG:(FLAG:USERV):ATB카운터 = 0
ELSEIF ISENEMY
    CFLAG:(TFLAG:USERV):ATB카운터 = 0
ENDIF
;전투불능 판정
IF !ISENEMY && BASE:(TFLAG:TARGETV):희망 <= 0 && ((CFLAG:(TFLAG:TARGETV):상태이상 & 1) != 1)
    CFLAG:(TFLAG:TARGETV):상태이상 += 1
    BASE:(TFLAG:TARGETV):희망 = 0
ELSEIF ISENEMY && BASE:(FLAG:TARGETV):희망 <= 0 && ((CFLAG:(FLAG:TARGETV):상태이상 & 1) != 1)
    CFLAG:(FLAG:TARGETV):상태이상 += 1
    BASE:(FLAG:TARGETV):희망 = 0
ENDIF

IF !ISENEMY
    FOR LCOUNT,0,VARSIZE("버프지속시간")
        CALL TURNOFF_BUFF(FLAG:USERV,LCOUNT)
    NEXT
ELSEIF ISENEMY
    FOR LCOUNT,0,VARSIZE("버프지속시간")
        CALL TURNOFF_BUFF(TFLAG:USERV,LCOUNT)
    NEXT
ENDIF

@SETCOLOR_BATTLE_ENEMY(LNUM)
#DIM DYNAMIC LNUM
#DIM DYNAMIC YELLOWV
#DIM DYNAMIC GREENV
#DIM DYNAMIC DOUBLEV
IF TFLAG:동료1ATB커서위치 == LNUM
    SELECTCASE TFLAG:동료1ATB커서상태
        CASE 1,2
            YELLOWV = 1
        CASE 4,5
            SIF SKILL_DATA:(AVAILABLE_SKILL:(FLAG:1):(TFLAG:동료1스킬커서위치)):5 == 0
                YELLOWV = 1    
    ENDSELECT
ENDIF
IF TFLAG:동료2ATB커서위치 == LNUM
    SELECTCASE TFLAG:동료2ATB커서상태
        CASE 1,2
            GREENV = 1
        CASE 4,5
            SIF SKILL_DATA:(AVAILABLE_SKILL:(FLAG:2):(TFLAG:동료2스킬커서위치)):5 == 0
                GREENV = 1
    ENDSELECT
ENDIF
SIF GREENV == 1 && YELLOWV == 1
    DOUBLEV = 1

IF DOUBLEV == 1
    SETCOLORBYNAME GreenYellow
ELSEIF GREENV == 1
    SETCOLORBYNAME Green
ELSEIF YELLOWV == 1
    SETCOLORBYNAME Yellow
ENDIF

;스킬 선택 중 표시하는 스킬 이름을 출력
;동어반복을 피하기 위한 함수
@SHOW_BATTLE_SKILL_SELECT_NAME(LPARTNER,LKEY)
#DIM DYNAMIC LPARTNER;1또는2
#DIM DYNAMIC LKEY;0~7
SELECTCASE LPARTNER
    CASE 1
        SIF TFLAG:동료1스킬커서위치 == LKEY
            SETCOLORBYNAME Yellow
    CASE 2
        SIF TFLAG:동료2스킬커서위치 == LKEY
            SETCOLORBYNAME Green
ENDSELECT
IF AVAILABLE_SKILL:(FLAG:LPARTNER):LKEY
    PRINTFORM %SKILL_NAME:(AVAILABLE_SKILL:(FLAG:LPARTNER):LKEY)%
    PRINT_SPACE 100 * (5 - STRLENSU(SKILL_NAME:(AVAILABLE_SKILL:(FLAG:LPARTNER):LKEY)))
    SELECTCASE SKILL_DATA:(AVAILABLE_SKILL:(FLAG:LPARTNER):LKEY):11
        CASE 0
            PRINTFORM %TOFULL("HP")%%TOFULL(TOSTR(SKILL_DATA:(AVAILABLE_SKILL:(FLAG:LPARTNER):LKEY):10,"D2"))%
        CASE 1
            PRINTFORM %TOFULL("SP")%%TOFULL(TOSTR(SKILL_DATA:(AVAILABLE_SKILL:(FLAG:LPARTNER):LKEY):10,"D2"))%
    ENDSELECT
ELSE
    PRINT ＥＭＰＴＹ
    PRINT_SPACE 400
ENDIF
RESETCOLOR

@SHOW_BATTLE_COMMAND
#DIM DYNAMIC LCOUNT
#DIM DYNAMIC LCOUNT2
#DIMS DYNAMIC LBUTTONS,12

SELECTCASE TFLAG:동료1ATB커서상태
    CASE 0
        LBUTTONS:0 = 
        IF CFLAG:(FLAG:1):변신가능 != 0
            LBUTTONS:1 = 변신
        ELSE
            LBUTTONS:1 = 
        ENDIF
        LBUTTONS:2 = 
        LBUTTONS:6 = 공격
        LBUTTONS:7 = 스킬
        LBUTTONS:8 = 방어
    CASE 1,3,4
        LBUTTONS:0 = 확인
        LBUTTONS:1 = △　
        LBUTTONS:2 = 취소
        LBUTTONS:6 = ≪　
        LBUTTONS:7 = ▽　
        LBUTTONS:8 = ≫　
    CASE 2,5,6,7
        LBUTTONS:0 = 확인
        LBUTTONS:1 = 
        LBUTTONS:2 = 취소
        LBUTTONS:6 = 
        LBUTTONS:7 = 
        LBUTTONS:8 = 
ENDSELECT
SELECTCASE TFLAG:동료2ATB커서상태
    CASE 0
        LBUTTONS:3 = 
        IF CFLAG:(FLAG:2):변신가능 != 0
            LBUTTONS:4 = 변신
        ELSE
            LBUTTONS:4 = 
        ENDIF
        LBUTTONS:5 = 
        LBUTTONS:9 = 공격
        LBUTTONS:10 = 스킬
        LBUTTONS:11 = 방어
    CASE 1,3,4
        LBUTTONS:3 = 확인
        LBUTTONS:4 = △　
        LBUTTONS:5 = 취소
        LBUTTONS:9 = ≪　
        LBUTTONS:10 = ▽　
        LBUTTONS:11 = ≫　
    CASE 2,5,6,7
        LBUTTONS:3 = 확인
        LBUTTONS:4 = 
        LBUTTONS:5 = 취소
        LBUTTONS:9 = 
        LBUTTONS:10 = 
        LBUTTONS:11 = 
ENDSELECT
FOR LCOUNT2,0,2
    FOR LCOUNT,0,6
        IF LBUTTONS:(LCOUNT+LCOUNT2*6) == ""
            PRINTPLAINFORM [　]%"　"*2%
        ELSE
            {
                PRINTBUTTON "[" + TOFULL(BATTLEKEY:(LCOUNT+LCOUNT2*6)) + "]"
                + LBUTTONS:(LCOUNT+LCOUNT2*6),BATTLEKEY:(LCOUNT+LCOUNT2*6)
            }
        ENDIF
        SIF LCOUNT == 2;전각스페이스2개
            PRINT 　　
    NEXT
    PRINTL
NEXT

@SET_COMMESSAGE(COMMESSAGES,LNUM)
#DIMS REF COMMESSAGES
#DIM DYNAMIC LNUM;0또는1

SELECTCASE TFLAG:(7+LNUM)
    CASE 0
        COMMESSAGES:LNUM = 커맨드선택
    CASE 1
        COMMESSAGES:LNUM = 공격대상결정
    CASE 2
        COMMESSAGES:LNUM = 공격
    CASE 3
        COMMESSAGES:LNUM = %SKILL_HELP:(AVAILABLE_SKILL:(FLAG:(1+LNUM)):(TFLAG:(17+LNUM)))%
    CASE 4
        COMMESSAGES:LNUM = 스킬대상결정
    CASE 5
        COMMESSAGES:LNUM = 스킬사용
    CASE 6
        COMMESSAGES:LNUM = 방어
    CASE 7
        COMMESSAGES:LNUM = 변신
ENDSELECT

;입력값 처리
;ATB를 소모하는 경우 RETURN 1
@BATTLE_INPUT(KEYS,R_COMMANDS,R_TARGETV,R_USERV)
#DIMS DYNAMIC KEYS
#DIMS REF R_COMMANDS
#DIM REF R_TARGETV
#DIM REF R_USERV

#DIM DYNAMIC SKILLV

SIF ISDYING(FLAG:동료1) && (STRFIND("qweasd",KEYS) != -1)
    RETURN 0
SIF ISDYING(FLAG:동료2) && (STRFIND("uiojkl",KEYS) != -1)
    RETURN 0
IF KEYS == "탌" || KEYS == ""
    R_COMMANDS '= ""
    R_TARGETV = 0
    R_USERV = 0
    RETURN 0
ENDIF
SELECTCASE TFLAG:동료1ATB커서상태
    CASE 0;초기
        SELECTCASE KEYS
            CASE "w";변신커맨드
                SIF CFLAG:(FLAG:1):변신가능
                    TFLAG:동료1ATB커서상태 = 7
            CASE "a";공격
                TFLAG:동료1ATB커서상태 = 1
            CASE "s";스킬
                TFLAG:동료1ATB커서상태 = 3
            CASE "d";방어
                TFLAG:동료1ATB커서상태 = 6
        ENDSELECT
    CASE 1;공격타게팅
        SELECTCASE RESULTS
            CASE "w"
                TFLAG:동료1ATB커서위치 = MOVE_BATTLE_TARGET_CURSOR("w",9)
            CASE "a"
                TFLAG:동료1ATB커서위치 = MOVE_BATTLE_TARGET_CURSOR("a",9)
            CASE "s"
                TFLAG:동료1ATB커서위치 = MOVE_BATTLE_TARGET_CURSOR("s",9)
            CASE "d"
                TFLAG:동료1ATB커서위치 = MOVE_BATTLE_TARGET_CURSOR("d",9)
            CASE "q"
                TFLAG:동료1ATB커서상태 = 2
            CASE "e"
                TFLAG:동료1ATB커서상태 = 0
        ENDSELECT
    CASE 2;공격확인
        SELECTCASE RESULTS
            CASE "q"
                IF CFLAG:(FLAG:동료1):ATB카운터 >= MAX_ATB
                    TFLAG:동료1ATB커서상태 = 0
                    R_COMMANDS '= "ATTACK"
                    R_TARGETV = TFLAG:동료1ATB커서위치
                    R_USERV = 1
                    RETURN 1
                ENDIF
            CASE "e"
                TFLAG:동료1ATB커서상태 = 1
        ENDSELECT
    CASE 3;스킬선택
        SELECTCASE RESULTS
            CASE "w"
                TFLAG:동료1스킬커서위치 = MOVE_BATTLE_TARGET_CURSOR("w",17)
            CASE "a"
                TFLAG:동료1스킬커서위치 = MOVE_BATTLE_TARGET_CURSOR("a",17)
            CASE "s"
                TFLAG:동료1스킬커서위치 = MOVE_BATTLE_TARGET_CURSOR("s",17)
            CASE "d"
                TFLAG:동료1스킬커서위치 = MOVE_BATTLE_TARGET_CURSOR("d",17)
            CASE "q"
                SKILLV = (AVAILABLE_SKILL:(FLAG:동료1):(TFLAG:동료1스킬커서위치))
                IF (SKILL_DATA:SKILLV:2 <= BASE:(FLAG:동료1):((SKILL_DATA:SKILLV:1)+1) || SKILL_DATA:SKILLV:3 != 0)
                    IF SKILL_DATA:SKILLV:5 == 0
                        TFLAG:동료1ATB커서상태 = 4
                    ELSE
                        TFLAG:동료1ATB커서상태 = 5
                    ENDIF
                ELSE
                    TFLAG:동료1ATB커서상태 = 3
                ENDIF
            CASE "e"
                TFLAG:동료1ATB커서상태 = 0
        ENDSELECT
    CASE 4;스킬타게팅
        SELECTCASE RESULTS
            CASE "w"
                TFLAG:동료1ATB커서위치 = MOVE_BATTLE_TARGET_CURSOR("w",9)
            CASE "a"
                TFLAG:동료1ATB커서위치 = MOVE_BATTLE_TARGET_CURSOR("a",9)
            CASE "s"
                TFLAG:동료1ATB커서위치 = MOVE_BATTLE_TARGET_CURSOR("s",9)
            CASE "d"
                TFLAG:동료1ATB커서위치 = MOVE_BATTLE_TARGET_CURSOR("d",9)
            CASE "q"
                TFLAG:동료1ATB커서상태 = 5
            CASE "e"
                TFLAG:동료1ATB커서상태 = 3
        ENDSELECT
    CASE 5;스킬확인
        SELECTCASE RESULTS
            CASE "q"
                IF CFLAG:(FLAG:동료1):ATB카운터 >= MAX_ATB
                    TFLAG:동료1ATB커서상태 = 0
                    R_COMMANDS '= "SKILL"
                    R_TARGETV = TFLAG:동료1ATB커서위치
                    R_USERV = 1
                    RETURN 1
                ENDIF
            CASE "e"
                TFLAG:동료1ATB커서상태 = 3
        ENDSELECT
    CASE 6;방어확인
        SELECTCASE RESULTS
            CASE "q"
                IF CFLAG:(FLAG:동료1):ATB카운터 >= MAX_ATB
                    TFLAG:동료1ATB커서상태 = 0
                    R_COMMANDS '= "GUARD"
                    R_TARGETV = 1
                    R_USERV = 1
                    RETURN 1
                ENDIF
            CASE "e"
                TFLAG:동료1ATB커서상태 = 0
        ENDSELECT
    CASE 7;변신확인
        SELECTCASE RESULTS
            CASE "q"
                IF CFLAG:(FLAG:동료1):ATB카운터 >= MAX_ATB
                    TFLAG:동료1ATB커서상태 = 0
                    R_COMMANDS '= "TRANS"
                    R_TARGETV = 1
                    R_USERV = 1
                    RETURN 1
                ENDIF
            CASE "e"
                TFLAG:동료1ATB커서상태 = 0
        ENDSELECT
ENDSELECT
SELECTCASE TFLAG:동료2ATB커서상태
    CASE 0;초기
        SELECTCASE KEYS
            CASE "i";변신커맨드
                SIF CFLAG:(FLAG:2):변신가능
                    TFLAG:동료2ATB커서상태 = 7
            CASE "j";공격
                TFLAG:동료2ATB커서상태 = 1
            CASE "k";스킬
                TFLAG:동료2ATB커서상태 = 3
            CASE "l";방어
                TFLAG:동료2ATB커서상태 = 6
        ENDSELECT
    CASE 1;공격타게팅
        SELECTCASE RESULTS
            CASE "i"
                TFLAG:동료2ATB커서위치 = MOVE_BATTLE_TARGET_CURSOR("i",10)
            CASE "j"
                TFLAG:동료2ATB커서위치 = MOVE_BATTLE_TARGET_CURSOR("j",10)
            CASE "k"
                TFLAG:동료2ATB커서위치 = MOVE_BATTLE_TARGET_CURSOR("k",10)
            CASE "l"
                TFLAG:동료2ATB커서위치 = MOVE_BATTLE_TARGET_CURSOR("l",10)
            CASE "u"
                TFLAG:동료2ATB커서상태 = 2
            CASE "o"
                TFLAG:동료2ATB커서상태 = 0
        ENDSELECT
    CASE 2;공격확인
        SELECTCASE RESULTS
            CASE "u"
                IF CFLAG:(FLAG:동료2):ATB카운터 >= MAX_ATB
                    TFLAG:동료2ATB커서상태 = 0
                    R_COMMANDS '= "ATTACK"
                    R_TARGETV = TFLAG:동료2ATB커서위치
                    R_USERV = 2
                    RETURN 1
                ENDIF
            CASE "o"
                TFLAG:동료2ATB커서상태 = 1
        ENDSELECT
    CASE 3;스킬선택
        SELECTCASE RESULTS
            CASE "i"
                TFLAG:동료2스킬커서위치 = MOVE_BATTLE_TARGET_CURSOR("i",18)
            CASE "j"
                TFLAG:동료2스킬커서위치 = MOVE_BATTLE_TARGET_CURSOR("j",18)
            CASE "k"
                TFLAG:동료2스킬커서위치 = MOVE_BATTLE_TARGET_CURSOR("k",18)
            CASE "l"
                TFLAG:동료2스킬커서위치 = MOVE_BATTLE_TARGET_CURSOR("l",18)
            CASE "u"
                SKILLV = (AVAILABLE_SKILL:(FLAG:2):(TFLAG:동료2스킬커서위치))
                IF (SKILL_DATA:SKILLV:2 <= BASE:(FLAG:동료2):((SKILL_DATA:SKILLV:1)+1) || SKILL_DATA:SKILLV:3 != 0)
                    IF SKILL_DATA:SKILLV:5 == 0
                        TFLAG:동료2ATB커서상태 = 4
                    ELSE
                        TFLAG:동료2ATB커서상태 = 5
                    ENDIF
                ELSE
                    TFLAG:동료2ATB커서상태 = 3
                ENDIF
            CASE "o"
                TFLAG:동료2ATB커서상태 = 0
        ENDSELECT
    CASE 4;스킬타게팅
        SELECTCASE RESULTS
            CASE "i"
                TFLAG:동료2ATB커서위치 = MOVE_BATTLE_TARGET_CURSOR("i",10)
            CASE "j"
                TFLAG:동료2ATB커서위치 = MOVE_BATTLE_TARGET_CURSOR("j",10)
            CASE "k"
                TFLAG:동료2ATB커서위치 = MOVE_BATTLE_TARGET_CURSOR("k",10)
            CASE "l"
                TFLAG:동료2ATB커서위치 = MOVE_BATTLE_TARGET_CURSOR("l",10)
            CASE "u"
                TFLAG:동료2ATB커서상태 = 5
            CASE "o"
                TFLAG:동료2ATB커서상태 = 3
        ENDSELECT
    CASE 5;스킬확인
        SELECTCASE RESULTS
            CASE "u"
                IF CFLAG:(FLAG:동료2):ATB카운터 >= MAX_ATB
                    TFLAG:동료2ATB커서상태 = 0
                    R_COMMANDS '= "SKILL"
                    R_TARGETV = TFLAG:동료2ATB커서위치
                    R_USERV = 2
                    RETURN 1
                ENDIF
            CASE "o"
                TFLAG:동료2ATB커서상태 = 3
        ENDSELECT
    CASE 6;방어확인
        SELECTCASE RESULTS
            CASE "u"
                IF CFLAG:(FLAG:동료2):ATB카운터 >= MAX_ATB
                    TFLAG:동료2ATB커서상태 = 0
                    R_COMMANDS '= "GUARD"
                    R_TARGETV = 2
                    R_USERV = 2
                    RETURN 1
                ENDIF
            CASE "o"
                TFLAG:동료2ATB커서상태 = 0
        ENDSELECT
    CASE 7;변신확인
        SELECTCASE RESULTS
            CASE "u"
                IF CFLAG:(FLAG:동료2):ATB카운터 >= MAX_ATB
                    TFLAG:동료2ATB커서상태 = 0
                    R_COMMANDS '= "TRANS"
                    R_TARGETV = 2
                    R_USERV = 2
                    RETURN 1
                ENDIF
            CASE "o"
                TFLAG:동료2ATB커서상태 = 0
        ENDSELECT
ENDSELECT
R_COMMANDS '= ""
R_TARGETV = 0
R_USERV = 0
RETURN 0

@RESET_BATTLE_CURSOR
#DIM DYNAMIC LCOUNT
#DIM DYNAMIC LCOUNT2
FOR LCOUNT2,0,2
    SIF TFLAG:(9+LCOUNT2) <= 0 || TFLAG:(9+LCOUNT2) > 6
        TFLAG:(9+LCOUNT2) = 1
NEXT
FOR LCOUNT2,0,2
    FOR LCOUNT,1,7
        IF TFLAG:(TFLAG:(9+LCOUNT2)) == 0
            TFLAG:(9+LCOUNT2) += 1
        ELSE
            BREAK
        ENDIF
        SIF TFLAG:(9+LCOUNT2) > 6
            TFLAG:(9+LCOUNT2) = 0
    NEXT
NEXT
FOR LCOUNT,0,2
    TFLAG:(17+LCOUNT) = 0
NEXT

;공격대상 선택 도중, wasd 또는 ijkl에 따라 커서 이동 결과를 반환하는 식중함수
;두번째 인수는 9,10을 받으며 TFLAG:9 또는 TFLAG:10을 참조하기 위함
@MOVE_BATTLE_TARGET_CURSOR(LKEY,LNUM)
#FUNCTION
#DIMS DYNAMIC LKEY
#DIM DYNAMIC LNUM
;각 적위치에서 wdsa 입력 시 이동하는 기본 위치 지정
#DIM DYNAMIC TARGET_FORM,8,4
IF LNUM != 9 && LNUM != 10 && LNUM != 17 && LNUM != 18
    DEBUGPRINTFORML MOVE_BATTLE_TARGET_CURSOR에 전달받은 두번째 파라미터(%LNUM%)가 9 또는 10 또는 17 또는 18이 아닙니다
    RETURNF 1
ENDIF
IF LNUM == 9 || LNUM == 10
    TARGET_FORM:1:0 = 4,2,4,3
    TARGET_FORM:2:0 = 5,3,5,1
    TARGET_FORM:3:0 = 6,1,6,2
    TARGET_FORM:4:0 = 1,5,1,6
    TARGET_FORM:5:0 = 2,6,2,4
    TARGET_FORM:6:0 = 3,4,3,5
ELSEIF LNUM == 17 || LNUM == 18
    TARGET_FORM:0:0 = 0,1,2,0
    TARGET_FORM:1:0 = 1,1,3,0
    TARGET_FORM:2:0 = 0,3,4,2
    TARGET_FORM:3:0 = 1,3,5,2
    TARGET_FORM:4:0 = 2,5,6,4
    TARGET_FORM:5:0 = 3,5,7,4
    TARGET_FORM:6:0 = 4,7,6,6
    TARGET_FORM:7:0 = 5,7,7,6
ENDIF

IF LNUM == 9 || LNUM == 10
    LNUM = TFLAG:LNUM
    SELECTCASE LKEY
        CASE "w","i"
            IF TFLAG:(TARGET_FORM:LNUM:0) && !ISDYING(TFLAG:(TARGET_FORM:LNUM:0))
                RETURNF TARGET_FORM:LNUM:0
            ELSEIF TFLAG:(TARGET_FORM:(TARGET_FORM:LNUM:0):1) && !ISDYING(TFLAG:(TARGET_FORM:(TARGET_FORM:LNUM:0):1))
                RETURNF TARGET_FORM:(TARGET_FORM:LNUM:0):1
            ELSEIF TFLAG:(TARGET_FORM:(TARGET_FORM:LNUM:0):3) && !ISDYING(TFLAG:(TARGET_FORM:(TARGET_FORM:LNUM:0):3))
                RETURNF TARGET_FORM:(TARGET_FORM:LNUM:0):3
            ELSE
                RETURNF LNUM
            ENDIF
        CASE "d","l"
            IF TFLAG:(TARGET_FORM:LNUM:1) && !ISDYING(TFLAG:(TARGET_FORM:LNUM:1))
                RETURNF TARGET_FORM:LNUM:1
            ELSEIF TFLAG:(TARGET_FORM:(TARGET_FORM:LNUM:1):1) && !ISDYING(TFLAG:(TARGET_FORM:(TARGET_FORM:LNUM:1):1))
                RETURNF TARGET_FORM:(TARGET_FORM:LNUM:1):1
            ELSEIF TFLAG:(TARGET_FORM:(TARGET_FORM:LNUM:0):1) && !ISDYING(TFLAG:(TARGET_FORM:(TARGET_FORM:LNUM:0):1))
                RETURNF TARGET_FORM:(TARGET_FORM:LNUM:0):1
            ELSEIF TFLAG:(TARGET_FORM:(TARGET_FORM:LNUM:0):3) && !ISDYING(TFLAG:(TARGET_FORM:(TARGET_FORM:LNUM:0):3))
                RETURNF TARGET_FORM:(TARGET_FORM:LNUM:0):3
            ELSE
                RETURNF LNUM
            ENDIF
        CASE "s","k"
            IF TFLAG:(TARGET_FORM:LNUM:2) && !ISDYING(TFLAG:(TARGET_FORM:LNUM:2))
                RETURNF TARGET_FORM:LNUM:2
            ELSEIF TFLAG:(TARGET_FORM:(TARGET_FORM:LNUM:2):1) && !ISDYING(TFLAG:(TARGET_FORM:(TARGET_FORM:LNUM:2):1))
                RETURNF TARGET_FORM:(TARGET_FORM:LNUM:2):1
            ELSEIF TFLAG:(TARGET_FORM:(TARGET_FORM:LNUM:2):3) && !ISDYING(TFLAG:(TARGET_FORM:(TARGET_FORM:LNUM:2):3))
                RETURNF TARGET_FORM:(TARGET_FORM:LNUM:2):3
            ELSE
                RETURNF LNUM
            ENDIF
        CASE "a","j"
            IF TFLAG:(TARGET_FORM:LNUM:3) && !ISDYING(TFLAG:(TARGET_FORM:LNUM:3))
                RETURNF TARGET_FORM:LNUM:3
            ELSEIF TFLAG:(TARGET_FORM:(TARGET_FORM:LNUM:3):3) && !ISDYING(TFLAG:(TARGET_FORM:(TARGET_FORM:LNUM:3):3))
                RETURNF TARGET_FORM:(TARGET_FORM:LNUM:3):3
            ELSEIF TFLAG:(TARGET_FORM:(TARGET_FORM:LNUM:0):3) && !ISDYING(TFLAG:(TARGET_FORM:(TARGET_FORM:LNUM:0):3))
                RETURNF TARGET_FORM:(TARGET_FORM:LNUM:0):3
            ELSEIF TFLAG:(TARGET_FORM:(TARGET_FORM:LNUM:0):1) && !ISDYING(TFLAG:(TARGET_FORM:(TARGET_FORM:LNUM:0):1))
                RETURNF TARGET_FORM:(TARGET_FORM:LNUM:0):1
            ELSE
                RETURNF LNUM
            ENDIF
    ENDSELECT
ELSEIF LNUM == 17 || LNUM == 18
    SELECTCASE LKEY
        CASE "w","i"
            IF AVAILABLE_SKILL:(FLAG:(-16+LNUM)):(TARGET_FORM:(TFLAG:LNUM):0)
                RETURNF TARGET_FORM:(TFLAG:LNUM):0
            ELSE
                RETURNF TFLAG:LNUM
            ENDIF
        CASE "d","l"
            IF AVAILABLE_SKILL:(FLAG:(-16+LNUM)):(TARGET_FORM:(TFLAG:LNUM):1)
                RETURNF TARGET_FORM:(TFLAG:LNUM):1
            ELSE
                RETURNF TFLAG:LNUM
            ENDIF
        CASE "s","k"
            IF AVAILABLE_SKILL:(FLAG:(-16+LNUM)):(TARGET_FORM:(TFLAG:LNUM):2)
                RETURNF TARGET_FORM:(TFLAG:LNUM):2
            ELSE
                RETURNF TFLAG:LNUM
            ENDIF
        CASE "a","j"
            IF AVAILABLE_SKILL:(FLAG:(-16+LNUM)):(TARGET_FORM:(TFLAG:LNUM):3)
                RETURNF TARGET_FORM:(TFLAG:LNUM):3
            ELSE
                RETURNF TFLAG:LNUM
            ENDIF
    ENDSELECT
ENDIF

;버프의 지속시간을 줄이고 지속시간이 0이라면 해제하는 함수
@TURNOFF_BUFF(USERV,KEYV)
#DIM DYNAMIC USERV
#DIM DYNAMIC KEYV
#DIM DYNAMIC BITV

SELECTCASE KEYV
    CASE 0
        BITV = 1
    CASEELSE
        BITV = POWER(2,KEYV)
ENDSELECT
IF (CFLAG:USERV:버프적용중 & BITV) != 0
    SIF 버프지속시간:USERV:KEYV > 0
        버프지속시간:USERV:KEYV -= 1
    SIF 버프지속시간:USERV:KEYV <= 0
        CFLAG:USERV:버프적용중 -= BITV
ENDIF